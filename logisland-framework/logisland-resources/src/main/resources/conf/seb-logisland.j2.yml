#########################################################################################################
# Logisland configuration script template
#########################################################################################################

version: 0.12.2
documentation: LogIsland analytics main config file. Put here every engine or component config

#########################################################################################################
# engine
engine:
  component: com.hurence.logisland.engine.spark.KafkaStreamProcessingEngine
  type: engine
  documentation: Index some events with logisland
  configuration:
    spark.app.name: Events
    spark.master: local[4]
    spark.driver.memory: 2G
    spark.driver.cores: 1
    spark.executor.memory: 4G
    spark.executor.instances: 4
    spark.executor.cores: 2
    spark.yarn.queue: default
    spark.yarn.maxAppAttempts: 4
    spark.yarn.am.attemptFailuresValidityInterval: 1h
    spark.yarn.max.executor.failures: 20
    spark.yarn.executor.failuresValidityInterval: 1h
    spark.task.maxFailures: 8
    spark.serializer: org.apache.spark.serializer.KryoSerializer
    spark.streaming.batchDuration: 4000
    spark.streaming.backpressure.enabled: false
    spark.streaming.unpersist: false
    spark.streaming.blockInterval: 500
    spark.streaming.kafka.maxRatePerPartition: 3000
    spark.streaming.timeout: -1
    spark.streaming.unpersist: false
    spark.streaming.kafka.maxRetries: 3
    spark.streaming.ui.retainedBatches: 200
    spark.streaming.receiver.writeAheadLog.enable: false
    spark.ui.port: 4050

  controllerServiceConfigurations:

    - controllerService: ElasticsearchService
      component: com.hurence.logisland.service.elasticsearch.Elasticsearch_5_4_0_ClientService
      type: service
      documentation: elasticsearch service
      configuration:
#        hosts: sandbox:9300
        hosts: elasticsearch:9300
        cluster.name: es-logisland
        batch.size: 5000

  # Stream configs
  streamConfigurations:


    # parsing
    - stream: CookeoStream
      component: com.hurence.logisland.stream.spark.KafkaSEBEventStreamParallelProcessing
      type: stream
      documentation: a processor that converts raw apache logs into structured log records
      configuration:
        kafka.input.topics: logisland_raw
        kafka.output.topics: none
        kafka.error.topics: appevents_error
        kafka.input.topics.serializer: none
        kafka.output.topics.serializer: com.hurence.logisland.serializer.JsonSerializer
        kafka.error.topics.serializer: com.hurence.logisland.serializer.JsonSerializer
        kafka.metadata.broker.list: sl04h612.seb.com:9092,sl04p839.seb.com:9092,sl06r374.seb.com:9092
        kafka.zookeeper.quorum: sl04h612.seb.com:2181,sl04p839.seb.com:2181,sl06r374.seb.com:2181/kafka
        kafka.topic.autoCreate: true
        kafka.topic.default.partitions: 4
        kafka.topic.default.replicationFactor: 1
        # earliest, latest
        kafka.manual.offset.reset: latest
      processorConfigurations:

        - processor: CookeoEventsParser
          component: com.hurence.logisland.processor.SplitText
          type: parser
          configuration:
            record.type: mobile_event
            # if using only lookarounds, end with .* to capture all field and populate record_raw_value
            value.regex: '(?=.*"ssid":"([^"]*)".*)?(?=.*"platform":"([^"]*)".*)?(?=.*"anonymousid":"([^"]*)".*)?(?=.*"userid":"([^"]*)".*)?(?=.*"type":"([^"]*)".*)?(?=.*,"date":"([^"]*)",.*)?(?=.*"application_name":"([^"]*)".*)?(?=.*"application_version":"([^"]*)".*)?(?=.*"libVersion":"([^"]*)".*)?(?=.*"model":"([^"]*)".*)?(?=.*"os_version":"([^"]*)".*)?(?=.*"params":\[([^\]]*)\].*)?(?=.*"context":(\{[^\}]*\}).*)?(?=.*"application_lang_market":"([^"]*)".*)?(?=.*"rcuid":"([^"]*)".*)?(?=.*"application_market":"([^"]*)".*)?(?=.*"application_lang":"([^"]*)".*)?.*'
            value.fields: event_ssid,event_platform,event_anonymousid,event_userid,event_type,event_date,event_application_name,event_application_version,event_libVersion,event_model,event_os_version,event_params,event_context,event_application_langMarket,event_rcuid,event_application_market,event_application_lang

        - processor: FilterRecordsSSID
          component: com.hurence.logisland.processor.FilterRecords
          type: processor
          configuration:
            field.name: event_ssid
            field.value: (?!tefal)(?!rowenta)(?!t-fal)(?!krups\.)(?!moulinex).*

#        - processor: FilterRecordsEvent
#          component: com.hurence.logisland.processor.FilterRecords
#          type: processor
#          configuration:
#            field.name: event_type
#            field.value: (?:MOBILEPAGELOAD|BAKING)

        - processor: EnrichRecordsElasticsearch
          component: com.hurence.logisland.processor.EnrichRecordsElasticSearch
          type: processor
          configuration:
            elasticsearch.client.service: ElasticsearchService
            record.key: event_rcuid
            es.index: profile_ucr
            es.type: profile_ucr_type
            es.includes.field: firstname


       # Bulk add to elasticsearch
        - processor: BulkAddElasticsearch
          component: com.hurence.logisland.processor.elasticsearch.BulkAddElasticsearch
          type: processor
          documentation: a processor that indexes processed events in elasticsearch
          configuration:
            elasticsearch.client.service: ElasticsearchService
            default.index: logisland
            default.type: event
            timebased.index: today
            es.index.field: search_index
            es.type.field: record_type